<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Theta Tau Attendance</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; display:flex; justify-content:center; align-items:center; min-height:100vh; position:relative; overflow-x:hidden; background:#f8e7ad; }
    body::before{ content:""; position:absolute; inset:0; background: linear-gradient(rgba(245,223,135,0.6), rgba(245,223,135,0.8)), url('tt_shield.png') repeat; background-size:90px; z-index:-1; }
    .container{ width:min(1000px,92vw); background:#fff4c7; border-radius:16px; padding:14px 16px 22px; box-shadow:5px 5px 10px rgba(0,0,0,0.1); text-align:center; }
    h1{ background:#fff2c7; display:inline-block; padding:10px 20px; border-radius:20px; box-shadow:4px 4px 0px #d6b445; color:#8b0000; font-size:2em; margin:6px 0 8px; }
    .subtitle{ color:#8b0000; margin:6px 0 10px; }
    .status { margin:0 0 10px; font-size:.9rem; }
    .status.ok { color:#1b5e20; }
    .status.warn { color:#b00020; }
    .leaderboard-link{ margin:4px 0 16px; font-weight:bold; cursor:pointer; user-select:none; }
    .leaderboard-link a{ text-decoration:none; color:#8b0000; }
    .leaderboard-link a:hover{ text-decoration:underline; }
    .scroll-box{ max-height:60vh; overflow:auto; background:#fff4d0; padding:10px; border-radius:8px; box-shadow:2px 2px 5px rgba(0,0,0,0.2); }
    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:10px; border-bottom:1px solid gold; text-align:center; color:#8b0000; }
    th{ border-bottom:2px solid gold; position:sticky; top:0; background:#fff4d0; z-index:1; }
    tr:hover td{ background:#fdf2c2; }
    .row-green td{ background:#e9f7ea !important; color:#1b5e20; font-weight:600; }
    .name-red{ color:#b00020 !important; font-weight:700; }
    .pill-green{ color:#1b5e20 !important; font-weight:700; }
    .pill-red{ color:#b00020 !important; font-weight:700; }
    .misc-black{ color:#111 !important; }
    .modal { position:fixed; inset:0; display:none; justify-content:center; align-items:center; background:rgba(0,0,0,0.6); z-index:1000; }
    .modal.open{ display:flex; }
    .popup-content{ background:#fff0c9; border-radius:16px; padding:18px; width:min(700px,92vw); max-height:90vh; overflow:auto; box-shadow:0 4px 10px rgba(0,0,0,0.3); position:relative; text-align:left; }
    .popup-content h2{ color:#8b0000; margin:0 0 10px; }
    .close-btn{ position:absolute; right:16px; top:12px; font-size:28px; line-height:1; color:#8b0000; cursor:pointer; user-select:none; }
    .popup-section{ background:#fff9db; padding:10px; border-radius:8px; margin-bottom:12px; box-shadow:1px 1px 5px rgba(0,0,0,0.1); }
    .popup-section h3{ margin:4px 0 8px; color:#8b0000; }
    .popup-row{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#fffef3; padding:8px 10px; border-radius:6px; white-space:pre-wrap; }
    .line-green{ color:#1b5e20; font-weight:700; }
    .line-red { color:#b00020; font-weight:700; }
    .muted{ color:#555; }

    .subtitle {
  margin-bottom: 2px !important;
}

.leaderboard-link {
  margin: 0 !important;
  padding: 0 !important;
}

.scroll-box {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

.container {
  padding-bottom: 10px !important;
}
.leaderboard-link {
  margin: 10px 0 18px;       /* adds vertical space above/below */
  padding: 8px 0;            /* more internal breathing room */
  font-weight: bold;
  cursor: pointer;
  user-select: none;
  line-height: 1.6;          /* smooth spacing between text lines if it wraps */
}

  </style>
</head>
<body>
  <div class="container">
    <a href="https://docs.google.com/document/d/1Uvp9evEQdUnysuExGtLnssGuFzhLr_4yJfv6UYCazJw/edit?usp=sharing" target="_blank">
      <h1>Theta Tau Attendance</h1>
    </a>
    <div class="subtitle">You must reach 12 pts in each category</div>

    <div id="status" class="status"></div>

    <div class="leaderboard-link">
      <a id="openLeaderboard">🔥 CLICK HERE TO SEE THE LEADERBOARD 🔥</a>
    </div>

    <div class="scroll-box">
      <table id="pointsTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Social</th>
            <th>Service</th>
            <th>Professional</th>
            <th>Recruitment</th>
            <th>Miscellaneous</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Member Details Modal -->
  <div id="memberModal" class="modal" aria-hidden="true">
    <div class="popup-content">
      <span class="close-btn" data-close="memberModal">&times;</span>
      <h2 id="popupName">Member Details</h2>
      <div class="popup-section"><h3>Social</h3><div class="popup-row" id="popupSocial"></div></div>
      <div class="popup-section"><h3>Professional</h3><div class="popup-row" id="popupProfessional"></div></div>
      <div class="popup-section"><h3>Service</h3><div class="popup-row" id="popupService"></div></div>
      <div class="popup-section"><h3>Recruitment</h3><div class="popup-row" id="popupRecruitment"></div></div>
    </div>
  </div>

  <!-- Leaderboard Modal -->
  <div id="leaderboardModal" class="modal" aria-hidden="true">
    <div class="popup-content">
      <span class="close-btn" data-close="leaderboardModal">&times;</span>
      <h2>Leaderboard</h2>
      <div class="popup-section"><div class="popup-row" id="leaderboardBody"></div></div>
    </div>
  </div>

<script>
/* ================== CONFIG ================== */
// 1) Total sheet — use your publish-to-web CSV first (works without login)
const TOTAL_PUBLISH_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vSe8DRYLrA1sChNjnFJzaSLAIRMi3vM3ltR2kGF3BYdjjTsdMqW-_Txt8hXpQZF8ZxSH2pIxYmlvw34/pub?output=csv';
// 2) Fallback export URL — only works if the doc is shared “Anyone with link: Viewer”
const TOTAL_DOC_ID = '1EWww3LF_yp8Fbx32uHWRXReQwi9S5muAh1QFk-38uqo';
const TOTAL_GID    = '0';
const TOTAL_EXPORT_URL =
  `https://docs.google.com/spreadsheets/d/${TOTAL_DOC_ID}/export?format=csv&gid=${TOTAL_GID}`;

// Pillar sheets (same doc as above). Update any gid if your tabs change.
const PILLAR_DOC_ID = '1EWww3LF_yp8Fbx32uHWRXReQwi9S5muAh1QFk-38uqo';
const GIDS = {
  professional: '1466807679',
  social:       '925111569',
  service:      '332740941',
  recruitment:  '1693967171'
};
const sheetCSV = (gid) =>
  `https://docs.google.com/spreadsheets/d/${PILLAR_DOC_ID}/export?format=csv&gid=${gid}`;

// Pillar thresholds
const THRESHOLDS = { social: 8, service: 6, professional: 5 };

/* ============ UTIL / DIAGNOSTICS ============ */
const statusEl = document.getElementById('status');
function setStatus(msg, type='ok'){ statusEl.textContent = msg; statusEl.className = `status ${type}`; }

function stripBOM(s){ return s.charCodeAt(0) === 0xFEFF ? s.slice(1) : s; }

// Robust CSV parser (handles quotes and commas)
function parseCSV(text){
  const rows = [];
  let i = 0, field = '', row = [], inQuotes = false;
  for(; i < text.length; i++){
    const c = text[i];
    if(inQuotes){
      if(c === '"'){
        if(text[i+1] === '"'){ field += '"'; i++; }
        else inQuotes = false;
      } else field += c;
    } else {
      if(c === '"') inQuotes = true;
      else if(c === ','){ row.push(field); field=''; }
      else if(c === '\n'){ row.push(field); rows.push(row); row=[]; field=''; }
      else if(c === '\r'){ /* ignore */ }
      else field += c;
    }
  }
  if(field.length || row.length){ row.push(field); rows.push(row); }
  return rows;
}

async function fetchCSV(url){
  const res = await fetch(url, { cache:'no-store' });
  if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText} for ${url}`);
  const text = await res.text();
  return parseCSV(stripBOM(text.trim()));
}

async function loadTotalWithFallback(){
  const reasons = [];
  // warn about file:// usage
  if(location.protocol === 'file:'){
    setStatus('Tip: running from file:// — if loading fails, start a local server (e.g., python3 -m http.server).', 'warn');
  }
  // Try publish URL first
  try{
    console.info('Fetching TOTAL (publish):', TOTAL_PUBLISH_URL);
    return await fetchCSV(TOTAL_PUBLISH_URL);
  }catch(e){
    console.warn('Publish URL failed:', e);
    reasons.push(`Publish failed: ${e.message}`);
  }
  // Fallback to export URL
  try{
    console.info('Fetching TOTAL (export):', TOTAL_EXPORT_URL);
    return await fetchCSV(TOTAL_EXPORT_URL);
  }catch(e){
    console.warn('Export URL failed:', e);
    reasons.push(`Export failed: ${e.message}`);
  }
  throw new Error(reasons.join(' | '));
}

/* ============== TABLE RENDERING ============== */
let totalRows = [];

function applyPillarColor(td, num, key){
  if(Number.isNaN(num)) return;
  td.classList.add(num >= THRESHOLDS[key] ? 'pill-green' : 'pill-red');
}

function renderTable(){
  const tbody = document.querySelector('#pointsTable tbody');
  tbody.innerHTML = '';

  for(let i=1;i<totalRows.length;i++){
    const r = totalRows[i];
    if(!r || r.length === 0) continue;

    const tr = document.createElement('tr');

    const pillarsReached = (r[5] || '').toString().trim().toUpperCase() === 'TRUE';
    if(pillarsReached) tr.classList.add('row-green');

    // Name
    const nameTd = document.createElement('td');
    nameTd.textContent = (r[0] || '').trim();
    if(!pillarsReached) nameTd.classList.add('name-red');
    tr.appendChild(nameTd);

    // Social (B)
    const socialTd = document.createElement('td');
    const nB = parseFloat(r[1]); socialTd.textContent = Number.isNaN(nB) ? (r[1]||'') : nB;
    applyPillarColor(socialTd, nB, 'social'); tr.appendChild(socialTd);

    // Service (C)
    const serviceTd = document.createElement('td');
    const nC = parseFloat(r[2]); serviceTd.textContent = Number.isNaN(nC) ? (r[2]||'') : nC;
    applyPillarColor(serviceTd, nC, 'service'); tr.appendChild(serviceTd);

    // Professional (D)
    const profTd = document.createElement('td');
    const nD = parseFloat(r[3]); profTd.textContent = Number.isNaN(nD) ? (r[3]||'') : nD;
    applyPillarColor(profTd, nD, 'professional'); tr.appendChild(profTd);

    // Recruitment (H)
    const recTd = document.createElement('td');
    const nH = parseFloat(r[7]); recTd.textContent = Number.isNaN(nH) ? (r[7]||'') : nH;
    tr.appendChild(recTd);

    // Misc (G) – always black
    const miscTd = document.createElement('td');
    miscTd.textContent = r[6] ?? '';
    miscTd.classList.add('misc-black');
    tr.appendChild(miscTd);

    tr.addEventListener('click', () => openMemberModal((r[0]||'').trim()));
    tbody.appendChild(tr);
  }
}

/* ================== MODALS =================== */
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }

document.addEventListener('click', (e)=>{
  const closeId = e.target.getAttribute('data-close');
  if(closeId) closeModal(closeId);
  if(e.target.classList.contains('modal')) e.target.classList.remove('open');
});

/* ======== MEMBER DETAIL POPUP LOADER ======== */
async function openMemberModal(name){
  document.getElementById('popupName').textContent = name;

// helper to load one sheet and generate lines with strict checkbox logic:
// GREEN only if TRUE or numeric > 0; otherwise RED (show the event name)
async function loadSheet(gid){
  try{
    const rows = await fetchCSV(sheetCSV(gid));
    if(!rows.length) return 'No data found.';
    const headers = rows[0];
    const member = rows.find(r => (r[0]||'').trim().toLowerCase() === name.trim().toLowerCase());
    if(!member) return 'No data found.';

    let out = '';
    let total = 0; // count of attended/credited events

    // start at column B (idx=1)
    for(let c=1; c<headers.length; c++){
      const label = (headers[c]||'').trim();
      if(!label) continue;

      const raw = (member[c]||'').trim();
      const isTrue = raw.toUpperCase() === 'TRUE';
      const num = parseFloat(raw);
      const isNum = !Number.isNaN(num);

      // determine green vs red + text to display
      if(isTrue || (isNum && num > 0)){
        const line = isNum ? `${label}: ${num}` : `${label}`;
        out += `<div class="line-green">${line}</div>\n`;
        total++;
      } else {
        // unchecked / FALSE / empty / 0 -> show event name in RED
        out += `<div class="line-red">${label}</div>\n`;
      }
    }

    // Optional "Total: X" line at the end
    out += `<div class="line-green" style="margin-top:.5rem;">Total: ${total}</div>\n`;

    return out || '<span class="muted">No events found.</span>';
  }catch(err){
    console.error('Error loading sheet', gid, err);
    return 'Error loading data.';
  }
}


  const [socialHTML, profHTML, serviceHTML, recruitHTML] = await Promise.all([
    loadSheet(GIDS.social),
    loadSheet(GIDS.professional),
    loadSheet(GIDS.service),
    loadSheet(GIDS.recruitment),
  ]);

  document.getElementById('popupSocial').innerHTML = socialHTML;
  document.getElementById('popupProfessional').innerHTML = profHTML;
  document.getElementById('popupService').innerHTML = serviceHTML;
  document.getElementById('popupRecruitment').innerHTML = recruitHTML;

  openModal('memberModal');
}

/* ================ LEADERBOARD ================ */
document.getElementById('openLeaderboard').addEventListener('click', () => {
  try{
    const nameIdx = 0, totalIdx = 4;
    const items = totalRows.slice(1)
      .filter(r => r && r.length)
      .map(r => ({ name: (r[nameIdx]||'').trim(), total: parseFloat(r[totalIdx]) || 0 }))
      .sort((a,b) => b.total - a.total);

    const lines = items.map((it, i) => `${String(i+1).padStart(2,' ')}. ${it.name} — ${it.total}`).join('\n');
    document.getElementById('leaderboardBody').innerHTML = `<pre>${lines}</pre>`;
    openModal('leaderboardModal');
  }catch(err){
    document.getElementById('leaderboardBody').textContent = 'Unable to load leaderboard.';
    openModal('leaderboardModal');
  }
});

/* ================= INITIAL LOAD =============== */
(async function init(){
  try{
    setStatus('Loading Total sheet…');
    totalRows = await loadTotalWithFallback();
    renderTable();
    setStatus('Loaded Total sheet.', 'ok');
  }catch(err){
    console.error('Total sheet failed:', err);
    setStatus('Could not load the Total sheet CSV. Open console for details.', 'warn');
  }
})();
</script>
</body>
</html>
