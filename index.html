<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Theta Tau Attendance</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      display: flex; justify-content: center; align-items: center;
      height: 100vh; position: relative; overflow: hidden;
    }
    body::before{
      content:""; position:absolute; inset:0;
      background: linear-gradient(rgba(245,223,135,.6), rgba(245,223,135,.8)), url('tt_shield.png') repeat;
      background-size: 90px; z-index:-1;
    }
    .container{
      width: 90%; max-width: 900px; background:#fff4c7; border-radius:16px; padding:12px;
      box-shadow: 5px 5px 10px rgba(0,0,0,.1); text-align:center;
    }
    h1{
      background:#fff2c7; display:inline-block; padding:10px 20px; border-radius:20px;
      box-shadow:4px 4px 0 #d6b445; color:#8b0000; font-size:2em; margin-bottom:10px;
    }
    .subtitle{ color:#8b0000; margin: 16px 0 8px; }
    .scroll-box{ max-height:420px; overflow-y:auto; background:#fff4d0; padding:10px; border-radius:8px; box-shadow:2px 2px 5px rgba(0,0,0,.2); }
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:10px; border-bottom:1px solid gold; text-align:left; color:#8b0000; }
    th{ border-bottom:2px solid gold; position:sticky; top:0; background:#fff4d0; }
    tr:hover td{ background:#fdf2c2; cursor:pointer; }
    .name-low{ font-weight:bold; color:red !important; }

    /* Modal */
    #popupModal{
      position:fixed; inset:0; background:rgba(0,0,0,.6);
      display:none; justify-content:center; align-items:center; z-index:1000;
    }
    .popup-content{
      background:#fff0c9; border-radius:16px; padding:20px; width:95%; max-width:700px;
      max-height:90%; overflow-y:auto; box-shadow:0 4px 10px rgba(0,0,0,.3); position:relative; text-align:left;
    }
    #closePopup{ position:absolute; right:20px; top:14px; font-size:28px; color:#8b0000; cursor:pointer; }
    .popup-content h2{ color:#8b0000; margin:0 0 10px; }

    .legend{ font-size:.9rem; color:#6b0000; margin-bottom:8px; }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      padding:8px 10px; border-radius:999px; background:#fffef3; border:1px solid #eee; font-family:monospace;
    }
    .chip.green{ border-color:#3cab3c; color:#116611; background:#ebfaeb; }
    .chip.red{ border-color:#e28b8b; color:#7b0d0d; background:#ffecec; }
    .chip.black{ border-color:#888; color:#222; background:#f7f7f7; }
    .section-title{ margin: 14px 0 6px; color:#8b0000; font-weight:bold; }
  </style>
</head>
<body>
  <div class="container">
    <a href="https://docs.google.com/document/d/1Uvp9evEQdUnysuExGtLnssGuFzhLr_4yJfv6UYCazJw/edit?usp=sharing" target="_blank"><h1>Theta Tau Attendance</h1></a>
    <div class="subtitle">Click a row to see that member’s checklist</div>
    <div class="scroll-box">
      <table id="pointsTable">
        <thead>
          <tr>
            <th style="width:55%;">Name</th>
            <th>Total</th>
            <th>Req Met?</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <div id="popupModal">
    <div class="popup-content">
      <span id="closePopup">&times;</span>
      <h2 id="popupName">Member Details</h2>
      <div class="legend">
        Green = checkbox checked or number in cell. If a number exists, it shows as <em>Header = #</em>.  
        Order: Greens → Reds → <strong>Total</strong> (black) → <strong>Requirements</strong> (last).
      </div>

      <div class="section-title">Green</div>
      <div id="chipsGreen" class="chips"></div>

      <div class="section-title">Red</div>
      <div id="chipsRed" class="chips"></div>

      <div class="section-title">Summary</div>
      <div id="chipsSummary" class="chips"></div>
    </div>
  </div>

  <script>
    const SHEET_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSe8DRYLrA1sChNjnFJzaSLAIRMi3vM3ltR2kGF3BYdjjTsdMqW-_Txt8hXpQZF8ZxSH2pIxYmlvw34/pub?output=csv';

    let headers = [];
    let rows = [];

    function parseCSV(text){
      return text.trim().split('\n').map(r => r.split(',').map(c => c.trim()));
    }
    function isNumeric(val){
      if (val === null || val === undefined || val === '') return false;
      const n = Number(val);
      return Number.isFinite(n);
    }
    function truthyWord(val){
      if (!val) return false;
      const v = val.toString().trim().toUpperCase();
      return v === 'TRUE' || v === 'YES';
    }
    function falsyWord(val){
      if (!val) return false;
      const v = val.toString().trim().toUpperCase();
      return v === 'FALSE' || v === 'NO';
    }

    fetch(SHEET_CSV)
      .then(r => r.text())
      .then(text => {
        const data = parseCSV(text);
        headers = data[0];
        rows = data.slice(1);

        const nameIdx = 0;
        const totalIdx = headers.findIndex(h => h && h.toLowerCase() === 'total');
        const reqIdx   = headers.findIndex(h => h && h.toLowerCase().includes('requirement'));

        const tbody = document.querySelector('#pointsTable tbody');
        tbody.innerHTML = '';

        rows.forEach(r => {
          const tr = document.createElement('tr');

          const tdName = document.createElement('td');
          tdName.textContent = r[nameIdx] || '(no name)';
          tr.appendChild(tdName);

          const tdTotal = document.createElement('td');
          tdTotal.textContent = totalIdx >= 0 ? (r[totalIdx] || '') : '';
          tr.appendChild(tdTotal);

          const tdReq = document.createElement('td');
          tdReq.textContent = reqIdx >= 0 ? (r[reqIdx] || '') : '';
          const reqVal = (r[reqIdx] || '').toString().trim().toUpperCase();
          if (reqVal === 'YES' || reqVal === 'TRUE') tdReq.style.color = 'green';
          else if (reqVal) tdReq.style.color = 'red';
          tr.appendChild(tdReq);

          tr.addEventListener('click', () => openModalForRow(r, totalIdx, reqIdx));
          tbody.appendChild(tr);
        });
      })
      .catch(err => console.error('CSV load error:', err));

    function openModalForRow(row, totalIdx, reqIdx){
      document.getElementById('popupName').textContent = row[0] || 'Member';
      const chipsGreen = document.getElementById('chipsGreen');
      const chipsRed   = document.getElementById('chipsRed');
      const chipsSummary = document.getElementById('chipsSummary');
      chipsGreen.innerHTML = '';
      chipsRed.innerHTML = '';
      chipsSummary.innerHTML = '';

      const greenItems = [];
      const redItems = [];

      // Build main chips, skipping TOTAL and REQUIREMENTS (handled later)
      for (let i = 1; i < headers.length; i++){
        if (i === totalIdx || i === reqIdx) continue; // handled after
        const header = headers[i] || `Col ${i+1}`;
        const raw = (row[i] ?? '').toString().trim();

        if (truthyWord(raw) || isNumeric(raw)) {
          const label = isNumeric(raw) ? `${header} = ${raw}` : header;
          greenItems.push(label);
        } else if (falsyWord(raw) || raw === '') {
          redItems.push(header);
        } else {
          redItems.push(header); // any other non-empty text counts as red
        }
      }

      // Greens first, then reds
      greenItems.forEach(t => chipsGreen.appendChild(makeChip(t, 'green')));
      redItems.forEach(t => chipsRed.appendChild(makeChip(t, 'red')));

      // TOTAL (second-to-last), black and always shown if header exists
      if (totalIdx >= 0) {
        const totalHeader = headers[totalIdx] || 'Total';
        const val = (row[totalIdx] ?? '').toString().trim();
        const label = isNumeric(val) ? `${totalHeader} = ${val}` : totalHeader;
        chipsSummary.appendChild(makeChip(label, 'black'));
      }

      // REQUIREMENTS (last), colored by value
      if (reqIdx >= 0) {
        const reqHeader = headers[reqIdx] || 'Requirements';
        const raw = (row[reqIdx] ?? '').toString().trim();
        const isGreen = truthyWord(raw);
        const reqLabel = reqHeader; // show header only (no = value)
        chipsSummary.appendChild(makeChip(reqLabel, isGreen ? 'green' : 'red'));
      }

      document.getElementById('popupModal').style.display = 'flex';
    }

    function makeChip(text, color){
      const div = document.createElement('div');
      div.className = `chip ${color}`;
      div.textContent = text;
      return div;
    }

    // Close modal handlers
    document.getElementById('closePopup').addEventListener('click', () => {
      document.getElementById('popupModal').style.display = 'none';
    });
    document.getElementById('popupModal').addEventListener('click', (e) => {
      if (e.target.id === 'popupModal') {
        document.getElementById('popupModal').style.display = 'none';
      }
    });
  </script>
</body>
</html>
